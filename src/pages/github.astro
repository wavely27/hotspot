---
import { supabase } from '../lib/supabase'

interface GithubRepo {
  name: string
  url: string
  description?: string
  description_cn?: string
  stars: number
  forks: number
  language?: string
  topics?: string[]
  ai_reason?: string
  fetched_date: string
}

let repos: GithubRepo[] = []
let error: string | null = null

if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('github_trending')
      .select('name, url, description, description_cn, stars, forks, language, topics, ai_reason, fetched_date')
      .order('fetched_date', { ascending: false })
      .order('stars', { ascending: false })
      .limit(30)

    if (fetchError) {
      error = fetchError.message
    } else {
      repos = data || []
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch repos'
  }
} else {
  error = 'Supabase not configured'
}

function formatNumber(num: number): string {
  if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'k'
  }
  return num.toString()
}

function getLanguageColor(lang?: string): string {
  const colors: Record<string, string> = {
    'Python': '#3572A5',
    'TypeScript': '#2b7489',
    'JavaScript': '#f1e05a',
    'Jupyter Notebook': '#DA5B0B',
    'C++': '#f34b7d',
    'Java': '#b07219',
    'Go': '#00ADD8',
    'Rust': '#dea584'
  }
  return colors[lang || ''] || '#8b949e'
}
---

<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>GitHub Trending AI - Hotspot</title>
	</head>
	<body>
		<main>
			<header class="hero">
				<h1>GitHub Trending AI</h1>
				<p>ÂÖ®ÁêÉÁÉ≠Èó® AI ÂºÄÊ∫êÈ°πÁõÆÂÆûÊó∂ËøΩË∏™</p>
			</header>

      {error ? (
        <div class="error-message">
          <p>Âä†ËΩΩÂ§±Ë¥•: {error}</p>
        </div>
      ) : repos.length === 0 ? (
        <div class="empty-message">
          <p>ÊöÇÊó†Ë∂ãÂäøÊï∞ÊçÆ</p>
        </div>
      ) : (
        <div class="repo-grid">
          {repos.map((repo) => (
            <a href={repo.url} target="_blank" rel="noopener noreferrer" class="repo-card">
              <div class="card-header">
                <h3 class="repo-name">
                  <span class="owner">{repo.name.split('/')[0]}</span>
                  <span class="divider">/</span>
                  <span class="name">{repo.name.split('/')[1] || repo.name}</span>
                </h3>
                <div class="stats-badge">
                  <div class="stat">
                    <span>‚≠ê</span>
                    {formatNumber(repo.stars)}
                  </div>
                </div>
              </div>

              <p class="description">
                {repo.description_cn || repo.description || 'ÊöÇÊó†ÊèèËø∞'}
              </p>

              {repo.ai_reason && (
                <div class="ai-insight">
                  <span class="ai-icon">ü§ñ</span>
                  <p>{repo.ai_reason}</p>
                </div>
              )}

              <div class="topics">
                {repo.topics?.slice(0, 4).map(topic => (
                  <span class="topic-tag">{topic}</span>
                ))}
              </div>

              <div class="card-footer">
                <div class="language">
                  <span class="lang-dot" style={`background-color: ${getLanguageColor(repo.language)}`}></span>
                  {repo.language || 'Unknown'}
                </div>
                <div class="stat-secondary">
                  <span>üîÄ {formatNumber(repo.forks)}</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
		</main>
    <script>
      import { trackPageView } from '../lib/analytics';
      trackPageView();
    </script>
	</body>
</html>

<style>
	body {
		margin: 0;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		background: #f9fafb;
		min-height: 100vh;
	}

	main {
		padding: 2rem 1rem;
		max-width: 1400px;
		margin: 0 auto;
	}

	.hero {
		text-align: center;
		padding: 3rem 0 3rem;
    position: relative;
	}

  .hero::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    border-radius: 2px;
  }

	.hero h1 {
		font-size: 3rem;
    letter-spacing: -0.02em;
		color: #1f2937;
		margin: 0 0 0.75rem 0;
		background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
	}

	.hero p {
		color: #6b7280;
		font-size: 1.25rem;
		margin: 0;
	}

  .error-message,
  .empty-message {
    text-align: center;
    padding: 3rem;
    background: #ffffff;
    border-radius: 16px;
    color: #6b7280;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    max-width: 600px;
    margin: 2rem auto;
  }

  .error-message {
    border-left: 4px solid #ef4444;
    color: #ef4444;
  }

  .repo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    padding: 1rem 0;
  }

  .repo-card {
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    height: 100%;
  }

  .repo-card:hover {
    border-color: #a78bfa;
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(139, 92, 246, 0.1), 0 10px 10px -5px rgba(139, 92, 246, 0.04);
  }

  .repo-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .repo-card:hover::before {
    opacity: 1;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    gap: 1rem;
  }

  .repo-name {
    margin: 0;
    font-size: 1.125rem;
    line-height: 1.4;
    word-break: break-all;
    color: #374151;
  }

  .repo-name .owner {
    color: #6b7280;
    font-weight: 400;
  }

  .repo-name .divider {
    color: #d1d5db;
    margin: 0 2px;
  }

  .repo-name .name {
    color: #1f2937;
    font-weight: 700;
  }

  .repo-card:hover .repo-name .name {
    color: #3b82f6;
  }

  .stats-badge {
    display: flex;
    align-items: center;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #4b5563;
    white-space: nowrap;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .description {
    color: #4b5563;
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0 0 1rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex-grow: 1;
  }

  .ai-insight {
    background: linear-gradient(to right, #eff6ff, #f5f3ff);
    border: 1px solid #e0e7ff;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1rem;
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
  }

  .ai-icon {
    font-size: 1.1rem;
    line-height: 1;
    margin-top: 2px;
  }

  .ai-insight p {
    margin: 0;
    font-size: 0.8125rem;
    color: #4c1d95;
    line-height: 1.4;
  }

  .topics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .topic-tag {
    font-size: 0.75rem;
    color: #4b5563;
    background: #f3f4f6;
    padding: 2px 8px;
    border-radius: 9999px;
    border: 1px solid #e5e7eb;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .language {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
  }

  .lang-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

	@media (max-width: 640px) {
    main {
      padding: 1rem;
    }

		.hero h1 {
			font-size: 2rem;
		}

    .repo-grid {
      grid-template-columns: 1fr;
    }
	}
</style>