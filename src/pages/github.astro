---
import { supabase } from '../lib/supabase'
import MainLayout from '../layouts/MainLayout.astro';
import GithubTrendList from '../components/GithubTrendList';
import Button from '../components/ui/Button.astro';
import { ArrowLeft } from 'lucide-react';

interface GithubRepo {
  name: string
  url: string
  description?: string
  description_cn?: string
  stars: number
  forks: number
  language?: string
  topics?: string[]
  ai_reason?: string
  fetched_date: string
}

let repos: GithubRepo[] = []
let error: string | null = null

if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('github_trending')
      .select('name, url, description, description_cn, stars, forks, language, topics, ai_reason, fetched_date')
      .order('fetched_date', { ascending: false })
      .order('stars', { ascending: false })
      .limit(30)

    if (fetchError) {
      error = fetchError.message
    } else {
      repos = data || []
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch repos'
  }
}
---

<MainLayout title="GitHub Trending AI - Hotspot">
  <div class="max-w-7xl mx-auto">
    <div class="mb-8 text-center">
      <div class="mb-6 flex justify-center">
        <Button href={import.meta.env.BASE_URL} variant="ghost" size="sm" class="gap-1 text-slate-500 hover:text-slate-900">
          <ArrowLeft size={16} />
          返回首页
        </Button>
      </div>
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-3 tracking-tight">
        GitHub Trending <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-900 to-gray-600">AI</span>
      </h1>
      <p class="text-slate-500 text-lg">全球热门 AI 开源项目实时追踪</p>
    </div>

    {error ? (
      <div class="text-center py-12 bg-white rounded-xl border border-slate-200 shadow-sm">
        <p class="text-semantic-error">加载失败: {error}</p>
      </div>
    ) : (
      <GithubTrendList client:load initialRepos={repos} />
    )}
  </div>

  <script>
    import { trackPageView } from '../lib/analytics';
    trackPageView();
  </script>
</MainLayout>
