---
import { supabase } from '../lib/supabase'
import Navigation from '../components/Navigation.astro';
import GithubTrendList from '../components/GithubTrendList';

interface GithubRepo {
  name: string
  url: string
  description?: string
  description_cn?: string
  stars: number
  forks: number
  language?: string
  topics?: string[]
  ai_reason?: string
  fetched_date: string
}

let repos: GithubRepo[] = []
let error: string | null = null

// Initial server-side/build-time fetch
if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('github_trending')
      .select('name, url, description, description_cn, stars, forks, language, topics, ai_reason, fetched_date')
      .order('fetched_date', { ascending: false })
      .order('stars', { ascending: false })
      .limit(30)

    if (fetchError) {
      error = fetchError.message
    } else {
      repos = data || []
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch repos'
  }
} else {
  // If supabase is not configured at build time, that's fine, we might rely on client side or show empty
  // But usually build time should have env vars.
  if (import.meta.env.PROD) {
     // In prod build, if no keys, maybe error
  }
}
---

<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>GitHub Trending AI - Hotspot</title>
	</head>
	<body>
		<main>
      <Navigation />
			<header class="hero">
				<h1>GitHub Trending AI</h1>
				<p>全球热门 AI 开源项目实时追踪</p>
			</header>

      {error ? (
        <div class="error-message">
          <p>加载失败: {error}</p>
        </div>
      ) : (
        <GithubTrendList client:load initialRepos={repos} />
      )}
		</main>
    <script>
      import { trackPageView } from '../lib/analytics';
      trackPageView();
    </script>
	</body>
</html>

<style>
	body {
		margin: 0;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
		background: #f9fafb;
		min-height: 100vh;
	}

	main {
		padding: 2rem 1rem;
		max-width: 1400px;
		margin: 0 auto;
	}

  /* Keep hero styles here or use the imported css? 
     Since we imported css in the React component, it will be added to the document. 
     However, for the static rendering of the header, we might want to ensure styles are present.
     Astro handles CSS imports. Let's just rely on the React component importing the CSS for now, 
     but actually, the header is outside the React component.
     So we should import the CSS file here too!
  */
</style>

<script>
  import '../styles/github.css';
</script>
