---
import AdminLayout from '../../layouts/AdminLayout.astro';
import DashboardCharts from '../../components/admin/DashboardCharts';
import { supabase } from '../../lib/supabase';
import { Users, MousePointer2, FileText, TrendingUp } from 'lucide-react';

let stats = {
  todayViews: 0,
  todayClicks: 0,
  totalReports: 0,
  chartData: [] as { date: string; views: number; clicks: number }[]
};

if (supabase) {
  const today = new Date().toISOString().split('T')[0];

  // 1. 获取今日浏览量
  const { count: viewsCount } = await supabase
    .from('page_views')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', today);
  
  // 2. 获取今日点击量
  const { count: clicksCount } = await supabase
    .from('hotspot_clicks')
    .select('*', { count: 'exact', head: true })
    .gte('created_at', today);

  // 3. 获取日报总数
  const { count: reportsCount } = await supabase
    .from('daily_reports')
    .select('*', { count: 'exact', head: true });

  // 4. 获取过去7天图表数据
  const last7Days: { date: string; views: number; clicks: number }[] = [];
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const dateStr = date.toISOString().split('T')[0];
    const nextDateStr = new Date(date.getTime() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const dayName = dayNames[date.getDay()];

    const { count: dayViews } = await supabase
      .from('page_views')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', dateStr)
      .lt('created_at', nextDateStr);

    const { count: dayClicks } = await supabase
      .from('hotspot_clicks')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', dateStr)
      .lt('created_at', nextDateStr);

    last7Days.push({
      date: dayName,
      views: dayViews || 0,
      clicks: dayClicks || 0
    });
  }

  stats = {
    todayViews: viewsCount || 0,
    todayClicks: clicksCount || 0,
    totalReports: reportsCount || 0,
    chartData: last7Days
  };
}

const statCards = [
  { label: '今日浏览量', value: stats.todayViews, icon: Users, color: 'text-blue-600', bg: 'bg-blue-50' },
  { label: '今日点击量', value: stats.todayClicks, icon: MousePointer2, color: 'text-purple-600', bg: 'bg-purple-50' },
  { label: '累计日报', value: stats.totalReports, icon: FileText, color: 'text-green-600', bg: 'bg-green-50' },
  { label: '转化率', value: `${stats.todayViews ? Math.round((stats.todayClicks / stats.todayViews) * 100) : 0}%`, icon: TrendingUp, color: 'text-orange-600', bg: 'bg-orange-50' },
];
---

<AdminLayout title="仪表盘">
  <!-- Stat Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    {statCards.map((stat) => (
      <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex items-center gap-4">
        <div class={`p-3 rounded-lg ${stat.bg}`}>
          <stat.icon className={`w-6 h-6 ${stat.color}`} />
        </div>
        <div>
          <p class="text-sm text-gray-500 font-medium">{stat.label}</p>
          <p class="text-2xl font-bold text-gray-900">{stat.value}</p>
        </div>
      </div>
    ))}
  </div>

  <!-- Charts -->
  <DashboardCharts client:load data={stats.chartData} />
</AdminLayout>
