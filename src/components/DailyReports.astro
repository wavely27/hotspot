---
/**
 * 日报列表组件
 * 展示日报摘要信息，点击跳转详情页
 */
import { supabase } from '../lib/supabase'
import Card from './ui/Card.astro'
import { Calendar, Layers, ChevronRight } from 'lucide-react'

interface DailyReport {
  id: string
  report_date: string
  content: string
  summary?: string
  created_at: string
}

let reports: DailyReport[] = []
let error: string | null = null

if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('daily_reports')
      .select('*')
      .order('report_date', { ascending: false })
      .limit(30)

    if (fetchError) {
      error = fetchError.message
    } else {
      reports = data || []
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch reports'
  }
} else {
  error = 'Supabase not configured'
}

// 从内容中提取统计信息
function extractStats(content: string): { totalCount: number; sourceCount: number } {
  const countMatch = content.match(/今日共收录 \*\*(\d+)\*\* 条热点，来自 \*\*(\d+)\*\* 个信息源/)
  if (countMatch) {
    return {
      totalCount: parseInt(countMatch[1]),
      sourceCount: parseInt(countMatch[2])
    }
  }
  
  const sources = content.match(/^## .+$/gm) || []
  const items = content.match(/^### \d+\. /gm) || []
  
  return { 
    totalCount: items.length, 
    sourceCount: sources.length 
  }
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  })
}

function formatShortDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', {
    month: 'short',
    day: 'numeric'
  })
}
---

<section class="max-w-4xl mx-auto py-8">
  <div class="text-center mb-10">
    <h2 class="text-3xl font-bold text-slate-900 mb-2">AI 热点日报</h2>
    <p class="text-slate-500">每日精选 AI 领域热点动态</p>
  </div>

  {error ? (
    <div class="p-8 text-center bg-semantic-error/10 rounded-xl text-semantic-error">
      <p>加载失败: {error}</p>
    </div>
  ) : reports.length === 0 ? (
    <div class="p-12 text-center bg-slate-50 rounded-xl border border-slate-200 text-slate-500">
      <p>暂无日报数据</p>
    </div>
  ) : (
    <div class="flex flex-col gap-4">
      {reports.map((report) => {
        const stats = extractStats(report.content)
        const baseUrl = import.meta.env.BASE_URL.replace(/\/$/, '')
        return (
          <a href={`${baseUrl}/reports/${report.report_date}`} class="block group">
            <Card hover class="flex items-center gap-4 p-5 border-slate-200">
              <div class="shrink-0 w-16 h-16 bg-gradient-to-br from-brand-primary to-brand-dark text-white rounded-xl flex items-center justify-center text-sm font-bold text-center leading-tight shadow-md">
                {formatShortDate(report.report_date)}
              </div>
              
              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-bold text-slate-900 mb-2 group-hover:text-brand-primary transition-colors">
                  {formatDate(report.report_date)}
                </h3>
                
                <div class="flex items-center gap-4 mb-3 text-sm text-slate-500">
                  <span class="flex items-center gap-1.5">
                    <Layers size={16} className="text-slate-400" />
                    {stats.totalCount} 条热点
                  </span>
                  <span class="flex items-center gap-1.5">
                    <Calendar size={16} className="text-slate-400" />
                    {stats.sourceCount} 个来源
                  </span>
                </div>
                
                {report.summary && (
                  <p class="text-sm text-slate-600 line-clamp-2 leading-relaxed">
                    {report.summary}
                  </p>
                )}
              </div>
              
              <div class="shrink-0 text-slate-300 group-hover:text-brand-primary group-hover:translate-x-1 transition-all">
                <ChevronRight size={24} />
              </div>
            </Card>
          </a>
        )
      })}
    </div>
  )}
</section>
