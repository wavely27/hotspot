---
/**
 * 日报列表组件
 * 展示日报摘要信息，点击跳转详情页
 */
import { supabase } from '../lib/supabase'

interface DailyReport {
  id: string
  report_date: string
  content: string
  summary?: string
  created_at: string
}

let reports: DailyReport[] = []
let error: string | null = null

if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('daily_reports')
      .select('*')
      .order('report_date', { ascending: false })
      .limit(30)

    if (fetchError) {
      error = fetchError.message
    } else {
      reports = data || []
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch reports'
  }
} else {
  error = 'Supabase not configured'
}

// 从内容中提取统计信息
function extractStats(content: string): { totalCount: number; sourceCount: number } {
  const countMatch = content.match(/今日共收录 \*\*(\d+)\*\* 条热点，来自 \*\*(\d+)\*\* 个信息源/)
  if (countMatch) {
    return {
      totalCount: parseInt(countMatch[1]),
      sourceCount: parseInt(countMatch[2])
    }
  }
  return { totalCount: 0, sourceCount: 0 }
}

// 格式化日期
function formatDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  })
}

// 格式化短日期
function formatShortDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('zh-CN', {
    month: 'short',
    day: 'numeric'
  })
}
---

<section class="daily-reports">
  <div class="section-header">
    <h2>AI 热点日报</h2>
    <p>每日精选 AI 领域热点动态</p>
  </div>

  {error ? (
    <div class="error-message">
      <p>加载失败: {error}</p>
    </div>
  ) : reports.length === 0 ? (
    <div class="empty-message">
      <p>暂无日报数据</p>
    </div>
  ) : (
    <div class="reports-grid">
      {reports.map((report) => {
        const stats = extractStats(report.content)
        const sources = extractSources(report.content)
        return (
          <a href={`/reports/${report.report_date}`} class="report-card">
            <div class="report-date-badge">
              {formatShortDate(report.report_date)}
            </div>
            <div class="report-info">
              <h3>{formatDate(report.report_date)}</h3>
              <div class="report-stats">
                <span class="stat">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                  {stats.totalCount} 条热点
                </span>
                <span class="stat">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                  {stats.sourceCount} 个来源
                </span>
              </div>
              
              {report.summary && (
                <p class="report-summary">{report.summary}</p>
              )}
            </div>
            <div class="report-arrow">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
          </a>
        )
      })}
    </div>
  )}
</section>

<style>
  .daily-reports {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
  }

  .section-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .section-header h2 {
    font-size: 1.75rem;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
  }

  .section-header p {
    color: #6b7280;
    margin: 0;
  }

  .error-message,
  .empty-message {
    text-align: center;
    padding: 2rem;
    background: #f9fafb;
    border-radius: 8px;
    color: #6b7280;
  }

  .error-message {
    background: #fef2f2;
    color: #dc2626;
  }

  .reports-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .report-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .report-card:hover {
    border-color: #3b82f6;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
  }

  .report-date-badge {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    line-height: 1.2;
  }

  .report-info {
    flex: 1;
    min-width: 0;
  }

  .report-info h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.125rem;
    color: #1f2937;
    font-weight: 600;
  }

  .report-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .stat {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .stat svg {
    color: #9ca3af;
  }

  .report-summary {
    margin: 0;
    font-size: 0.875rem;
    color: #4b5563;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .report-arrow {
    flex-shrink: 0;
    color: #9ca3af;
    transition: color 0.2s, transform 0.2s;
  }

  .report-card:hover .report-arrow {
    color: #3b82f6;
    transform: translateX(4px);
  }

  @media (max-width: 640px) {
    .daily-reports {
      padding: 0 0.5rem;
    }

    .report-card {
      padding: 1rem;
    }

    .report-date-badge {
      width: 50px;
      height: 50px;
      font-size: 0.75rem;
    }

    .report-info h3 {
      font-size: 1rem;
    }

    .report-stats {
      flex-direction: column;
      gap: 0.25rem;
    }

    .section-header h2 {
      font-size: 1.5rem;
    }
  }
</style>
