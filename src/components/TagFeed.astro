---
import { supabase } from '../lib/supabase';
import TagFeedList from './TagFeedList';
import MainLayout from '../layouts/MainLayout.astro';
import Button from './ui/Button.astro';
import { ArrowLeft } from 'lucide-react';

interface Props {
  tag: string;
  title: string;
  description: string;
}

const { tag, title, description } = Astro.props;

interface Hotspot {
  id: string;
  title: string;
  url: string;
  summary: string;
  source: string;
  created_at: string;
  tags: string[];
  duplicate_group?: string;
  is_primary?: boolean;
}

let items: Hotspot[] = [];
let error: string | null = null;

if (supabase) {
  try {
    const { data, error: fetchError } = await supabase
      .from('hotspots')
      .select('*')
      .contains('tags', [tag])
      .eq('is_primary', true) // 只显示主条目
      .order('created_at', { ascending: false })
      .limit(50);

    if (fetchError) {
      error = fetchError.message;
    } else {
      items = data || [];
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'Failed to fetch items';
  }
}
---

<MainLayout title={`${title} | Hotspot`} description={description}>
  <div class="max-w-3xl mx-auto">
    <div class="mb-8 text-center">
      <div class="mb-6 flex justify-center">
        <Button href={import.meta.env.BASE_URL} variant="ghost" size="sm" class="gap-1 text-slate-500 hover:text-slate-900">
          <ArrowLeft size={16} />
          返回首页
        </Button>
      </div>
      <h1 class="text-3xl font-bold text-slate-900 mb-3">{title}</h1>
      <p class="text-slate-500 text-lg">{description}</p>
    </div>

    {error ? (
      <div class="text-center py-12 bg-white rounded-xl border border-slate-200 shadow-sm">
        <p class="text-semantic-error">加载失败: {error}</p>
      </div>
    ) : (
      <TagFeedList client:load tag={tag} initialItems={items} />
    )}
  </div>
  
  <script>
    import { trackPageView, trackClick } from '../lib/analytics';
    
    trackPageView();

    document.addEventListener('click', (e) => {
      const target = (e.target as HTMLElement).closest('a');
      if (target && target.href && target.target === '_blank') {
         trackClick(target.href, undefined, 'tag_feed_click');
      }
    });
  </script>
</MainLayout>
